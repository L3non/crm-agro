<!DOCTYPE html>
<html>
<head>
    <title>Vendas</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #eef2f5;
            padding: 20px;
        }

        h2 { margin-top: 0; }

        input, select, button {
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        button { cursor: pointer; }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .btn-voltar {
            text-decoration: none;
            background: #f4f6f8;
            padding: 8px 12px;
            border-radius: 6px;
            color: #333;
            font-weight: bold;
            border: 1px solid #ccc;
            margin-right: 8px;
            display: inline-block;
        }

        .grid-topo {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .bloco {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }

        .bloco h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        #selectCliente { height: 180px; }

        .linha-produto {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 8px;
            align-items: end;
        }

        .produto-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .financeiro {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        .total-venda {
            font-weight: bold;
            color: #0a7d3b;
            margin-top: 10px;
        }

        .total-periodo {
            margin: 15px 0;
            padding: 12px;
            background: #eafaf1;
            border-left: 6px solid #1e8449;
            font-weight: bold;
            color: #1e8449;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 8px;
            border: 1px solid #ccc;
        }

        th { background: #f4f6f8; }
    </style>

    <script>
        function calcularTotalVenda() {
            let total = 0;
            document.querySelectorAll(".produto-item").forEach(item => {
                total += parseFloat(item.dataset.qtd) * parseFloat(item.dataset.valor);
            });
            document.getElementById("totalVenda").innerText =
                total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        }

        function adicionarProduto() {
            const select = document.getElementById("produtoSelect");
            const produto = select.value;
            const nome = select.options[select.selectedIndex].text;
            const qtd = document.getElementById("qtdProduto").value;
            const valor = document.getElementById("valorProduto").value;

            if (!produto || !qtd || !valor) {
                alert("Preencha produto, quantidade e valor");
                return;
            }

            const div = document.createElement("div");
            div.className = "produto-item";
            div.dataset.qtd = qtd;
            div.dataset.valor = valor;

            div.innerHTML = `
                <span>${nome}</span>
                <span>${qtd}</span>
                <span>${parseFloat(valor).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</span>
                <button type="button" onclick="this.parentElement.remove(); calcularTotalVenda()">‚ùå</button>

                <input type="hidden" name="produto[]" value="${produto}">
                <input type="hidden" name="quantidade[]" value="${qtd}">
                <input type="hidden" name="valor[]" value="${valor}">
            `;

            document.getElementById("listaProdutos").appendChild(div);
            calcularTotalVenda();
        }
    </script>
</head>

<body>

<!-- BOT√ïES TOPO -->
<a href="/dashboard" class="btn-voltar">‚¨Ö Voltar</a>
<a href="/importar_vendas" class="btn-voltar">üì• Importar Excel</a>
<a href="/importar_pdf" class="btn-voltar">üìÑ Importar PDF</a>

<h2>üõí Nova Venda</h2>

<form method="post" class="card">

    <div class="grid-topo">
        <div>
            <label>Data</label>
            <input type="date" name="data" required>
        </div>
    </div>

    <div class="form-grid">
        <div class="bloco">
            <h3>üë§ Cliente</h3>
            <select name="cliente" id="selectCliente" size="8" required>
                {% for c in clientes %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="bloco">
            <h3>üì¶ Produtos</h3>

            <div class="linha-produto">
                <select id="produtoSelect">
                    {% for p in produtos %}
                    <option value="{{ p }}">{{ p }}</option>
                    {% endfor %}
                </select>

                <input type="number" id="qtdProduto" placeholder="Qtd">
                <input type="number" step="0.01" id="valorProduto" placeholder="Valor">
                <button type="button" onclick="adicionarProduto()">+</button>
            </div>

            <div id="listaProdutos"></div>
        </div>
    </div>

    <div class="bloco">
        <h3>üí∞ Financeiro</h3>
        <div class="financeiro">
            <input type="number" step="0.01" name="comissao" placeholder="Comiss√£o" required>
            <input type="number" name="parcelas" placeholder="Parcelas" required>
            <input type="month" name="primeiro_mes" required>
        </div>

        <div class="total-venda">
            Total da Venda: <span id="totalVenda">R$ 0,00</span>
        </div>
    </div>

    <button type="submit">üíæ Salvar Venda</button>
</form>

<h2>üìã Hist√≥rico de Vendas</h2>

<form method="get" class="card">
    <label>In√≠cio</label>
    <input type="date" name="inicio" value="{{ data_inicio }}">
    <label>Fim</label>
    <input type="date" name="fim" value="{{ data_fim }}">
    <button type="submit">üîç Filtrar</button>
    <a href="/vendas/exportar">üì• Exportar Excel</a>
</form>

{% if total_periodo is not none %}
<div class="total-periodo">
    üí∞ Total faturado no per√≠odo: R$ {{ total_periodo | moeda_br }}
</div>
{% endif %}

{% if historico %}
<table>
    <tr>
        <th>Data</th>
        <th>Cliente</th>
        <th>Valor</th>
        <th>A√ß√µes</th>
    </tr>
    {% for v in historico %}
    <tr>
        <td>{{ v.data }}</td>
        <td>{{ v.cliente }}</td>
        <td>R$ {{ v.valor_total | moeda_br }}</td>
        <td>
            <a href="/venda/{{ v.id }}">üîç</a>
            <a href="/venda/{{ v.id }}/excluir" onclick="return confirm('Excluir?')">‚ùå</a>
        </td>
    </tr>
    {% endfor %}
</table>
{% endif %}

</body>
</html>
